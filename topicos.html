<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Tópico</title>
</head>
<body>

<h1>Crear Tópico</h1>

<div>
    <h2>Productos Registrados</h2>
    <table id="productos-container">
        <!-- Aquí se mostrarán los productos -->
    </table>
</div>

<div>
    <h2>Crear Tópico</h2>
    <form id="formulario-topico">
        <label for="titulo">Título:</label>
        <input type="text" id="titulo" name="titulo" required>
        
        <label for="mensaje">Mensaje:</label>
        <textarea id="mensaje" name="mensaje" required></textarea>

        <label for="producto">Selecciona un Producto:</label>
        <select id="producto" name="producto" required>
            <!-- Las opciones se cargarán dinámicamente con JavaScript -->
        </select>

        <button type="button" onclick="crearTopico()">Crear Tópico</button>
    </form>
</div>

<script>
    async function obtenerProductosDesdeServidor() {
        try {
            const respuesta = await fetch('http://localhost:8080/productos');
            if (!respuesta.ok) {
                throw new Error(`Error al obtener productos. Código de estado: ${respuesta.status}`);
            }
            const productos = await respuesta.json();
            return productos;
        } catch (error) {
            console.error('Error al obtener productos:', error);
            throw error; // Relanzar el error para que pueda ser manejado en la función superior
        }
    }

    async function mostrarProductos() {
        const container = document.getElementById('productos-container');
        const productos = await obtenerProductosDesdeServidor();

        productos.forEach(producto => {
            const productoElement = document.createElement('tr');
            productoElement.innerHTML = `<td>${producto.nombre}</td><td>${producto.categoria}</td>`;
            container.appendChild(productoElement);
        });
    }

    async function cargarOpcionesProductos() {
        const selectProducto = document.getElementById('producto');
        const productos = await obtenerProductosDesdeServidor();

        productos.forEach(producto => {
            const option = document.createElement('option');
            option.value = producto.id;
            option.textContent = producto.nombre;
            selectProducto.appendChild(option);
        });
    }

    async function crearTopico() {
        const formulario = document.getElementById('formulario-topico');
        const datosTopico = {
            titulo: formulario.titulo.value,
            mensaje: formulario.mensaje.value,
            productoId: formulario.producto.value
        };

        try {
            const respuesta = await fetch('http://localhost:8080/topicos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosTopico)
            });

            if (!respuesta.ok) {
                throw new Error(`Error al crear el tópico. Código de estado: ${respuesta.status}`);
            }

            alert('Tópico creado exitosamente.');
            formulario.reset();
        } catch (error) {
            console.error('Error al crear el tópico:', error);
            // Manejar el error de manera adecuada, por ejemplo, mostrar un mensaje al usuario.
        }
    }

    // Llamadas a las funciones para mostrar productos y cargar opciones del select al cargar la página
    mostrarProductos();
    cargarOpcionesProductos();
</script>

</body>
